<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>血糖追踪管理系统</title>
    <link rel="icon" href="icon/哈喽.svg" type="image/x-icon"> <!-- 网站图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK（使用 compat 版本方便直接初始化） -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- 导出功能库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html, body {
            overflow-x: hidden;
            max-width: 100%;
            position: relative;
        }

        body {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .sidebar-header p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        .nav-item.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            color: inherit;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* 主题切换按钮 */
        .theme-toggle {
            margin: 15px 24px;
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .theme-toggle:hover {
            background-color: #e5e7eb;
        }

        .theme-toggle i {
            font-size: 1.2rem;
            color: inherit;
        }

        /* 暗色主题下的侧边栏调整 */
        body.dark-theme .theme-toggle {
            background-color: #374151;
            color: #f9fafb;
        }

        body.dark-theme .theme-toggle:hover {
            background-color: #4b5563;
        }

        body.dark-theme .sidebar-nav {
            color: #f9fafb;
        }

        body.dark-theme .nav-item {
            color: #e5e7eb;
        }

        body.dark-theme .nav-item:hover {
            background-color: #374151;
            color: #ffffff;
        }

        body.dark-theme .nav-item.active {
            background-color: #3730a3;
            color: #ffffff;
        }

        body.dark-theme .nav-item i {
            color: inherit;
        }

        /* 主内容区样式 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            transition: margin-left 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            width: calc(100% - var(--sidebar-width));
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        /* 带色块的标题 */
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-block {
            width: 6px;
            height: 30px;
            border-radius: 3px;
            background-color: var(--primary-color);
        }

        .header h2 {
            font-size: 1.8rem;
            color: var(--text-color);
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 18px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            color: white;
            font-size: 14px;
        }

        .btn i {
            color: inherit;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        /* 暗色主题下的按钮调整 */
        body.dark-theme .btn-secondary {
            background-color: #374151;
            color: #e5e7eb;
        }

        body.dark-theme .btn-secondary:hover {
            background-color: #4b5563;
            color: #ffffff;
        }

        /* 卡片样式 */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* 用户信息面板 */
        .user-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background-color: #f3f4f6;
            border-radius: var(--border-radius);
            min-width: 200px;
            max-width: 300px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            position: relative;
            flex-shrink: 0;
        }

        .user-avatar .avatar-initial {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-avatar.has-avatar img {
            display: block;
        }

        .user-avatar.has-avatar .avatar-initial {
            display: none;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            min-width: 0; /* 防止文本溢出 */
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 暗色主题下的用户面板 */
        body.dark-theme .user-panel {
            background-color: #374151;
        }

        /* 头像上传样式 */
        .avatar-upload-container {
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            border: 3px solid #e5e7eb;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .avatar-preview.has-avatar img {
            display: block;
        }

        .avatar-preview.has-avatar .avatar-initial {
            display: none;
        }

        .avatar-preview .avatar-initial {
            font-size: 3rem;
            font-weight: bold;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .avatar-upload-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .avatar-upload-input {
            display: none;
        }

        .avatar-upload-label {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .avatar-upload-label:hover {
            background-color: #4338ca;
        }

        .avatar-remove-btn {
            padding: 8px 16px;
            background-color: #f3f4f6;
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .avatar-remove-btn:hover {
            background-color: #e5e7eb;
        }

        /* 暗色主题下的头像上传 */
        body.dark-theme .avatar-preview {
            background-color: #374151;
            border-color: #4b5563;
        }

        body.dark-theme .avatar-preview .avatar-initial {
            color: #9ca3af;
        }

        body.dark-theme .avatar-remove-btn {
            background-color: #374151;
            color: #e5e7eb;
        }

        body.dark-theme .avatar-remove-btn:hover {
            background-color: #4b5563;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* 移动端适配 */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
                padding-top: calc(16px + 56px);
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
                margin-bottom: 20px;
                padding-bottom: 15px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 10px;
            }

            .user-panel {
                min-width: auto;
                flex: 1;
                max-width: none;
                order: 1;
                width: 100%;
            }

            .btn {
                padding: 12px 16px;
                font-size: 15px;
            }

            .btn span {
                display: inline !important;
            }

            .btn i {
                margin-right: 6px;
            }

            /* 移动端头像上传优化 */
            .avatar-preview {
                width: 100px;
                height: 100px;
            }

            .avatar-preview .avatar-initial {
                font-size: 2.5rem;
            }

            /* 移动端单位切换优化 */
            .unit-toggle {
                order: 0;
                margin-right: 0;
            }

            /* 移动端按钮优化 */
            .header-actions .btn-primary {
                min-width: auto;
                min-height: auto;
                order: 2;
            }

            /* 移动端用户面板优化 */
            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                flex-shrink: 0;
            }

            .user-name {
                font-size: 16px;
            }

            .user-status {
                font-size: 14px;
            }

            /* 移动端表单优化 */
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-row .form-group {
                min-width: 100%;
                margin-bottom: 16px;
            }

            .filter-bar {
                flex-direction: column;
                gap: 10px;
            }

            .filter-bar .form-group {
                width: 100%;
                min-width: 100%;
            }

            /* 移动端表格优化 */
            .table-container {
                border-radius: 0;
                margin: 0 -16px;
                width: calc(100% + 32px);
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-left: none;
                border-right: none;
            }

            table {
                min-width: 100%;
                font-size: 14px;
            }

            th, td {
                padding: 12px 10px;
                font-size: 14px;
            }

            /* 移动端卡片优化 */
            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .card-header {
                margin-bottom: 16px;
            }

            /* 移动端统计卡片优化 */
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .stat-label {
                font-size: 14px;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            /* 移动端图表优化 */
            .chart-container {
                height: 250px;
            }

            /* 移动端高级功能面板优化 */
            .advanced-actions {
                flex-direction: column;
            }

            .advanced-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .advanced-actions .btn span {
                display: inline;
            }

            /* 移动端标题优化 */
            .section-title {
                width: 100%;
            }
            
            .title-block {
                height: 25px;
            }
            
            .header h2 {
                font-size: 1.6rem;
            }

            .card-title {
                font-size: 1.2rem;
            }

            /* 移动端输入框字体大小 */
            input, select, textarea {
                font-size: 16px !important; /* 防止iOS自动缩放 */
            }

            /* 移动端个人化面板 */
            .personalization-panel {
                padding: 16px;
            }

            .personalization-title {
                font-size: 1.2rem;
            }

            .theme-options {
                flex-direction: column;
            }

            .theme-option {
                padding: 12px;
                text-align: center;
                font-size: 15px;
            }

            /* 移动端导出选项 */
            .export-options .form-row {
                flex-direction: column;
            }

            /* 移动端同步状态 */
            .sync-status .form-row {
                flex-direction: column;
            }

            /* 移动端同步状态卡片优化 */
            .sync-status-cards {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .sync-stat-card {
                padding: 16px;
            }
            
            .sync-stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .sync-stat-value {
                font-size: 1.5rem;
            }
            
            .sync-direction-options {
                gap: 8px;
            }
            
            .sync-direction-option {
                padding: 12px;
                gap: 12px;
            }
            
            .direction-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .sync-actions {
                flex-direction: column;
            }
            
            .sync-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .sync-frequency-select {
                width: 100%;
            }

            /* 移动端表单文字大小 */
            label {
                font-size: 15px;
            }

            p, span {
                font-size: 14px;
            }

            /* 移动端导航项 */
            .nav-item {
                padding: 16px 24px;
                font-size: 15px;
            }

            .nav-item i {
                font-size: 18px;
            }

            /* 移动端头部操作区重构 - 仅针对页面主标题栏 */
            .header > .header-actions {
                display: grid !important;
                grid-template-areas:
                    "user user"
                    "unit btn";
                grid-template-columns: 1fr auto;
                gap: 12px;
                width: 100%;
            }

            .header > .header-actions .user-panel {
                grid-area: user;
                width: 100%;
                margin-left: 0;
                justify-content: flex-start;
                background-color: var(--card-bg);
                padding: 10px;
                border-radius: 8px;
                border: 1px solid rgba(0,0,0,0.05);
            }

            body.dark-theme .header > .header-actions .user-panel {
                border-color: rgba(255,255,255,0.05);
            }

            .header > .header-actions .unit-toggle {
                grid-area: unit;
                margin: 0;
                justify-self: start;
            }

            .header > .header-actions .btn-primary,
            .header > .header-actions .btn-secondary {
                grid-area: btn;
                width: auto;
                margin: 0;
            }

            /* 移动端图表容器高度强制适配 */
            .chart-container {
                height: 250px !important;
            }

            /* 移动端表单按钮组优化 */
            #glucoseForm .form-row:last-child {
                flex-direction: column;
                gap: 12px;
            }

            #glucoseForm .form-row:last-child button {
                margin-left: 0 !important;
                width: 100%;
            }

            /* 移动端个人中心优化 */
            .avatar-upload-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .avatar-preview {
                margin-right: 0;
                margin-bottom: 16px;
                width: 120px;
                height: 120px;
            }

            .avatar-upload-btn {
                flex-direction: row;
                gap: 10px;
                justify-content: center;
                width: 100%;
            }

            /* 移动端主题选择优化 */
            .theme-options {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .theme-option {
                padding: 12px 4px;
                font-size: 13px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            .theme-option i {
                margin-right: 0;
                font-size: 1.4rem;
                margin-bottom: 0;
            }

            /* 移动端Alert优化 */
            #alertContainer {
                margin-bottom: 16px;
            }
            
            .alert {
                padding: 12px 16px;
                font-size: 14px;
            }
        }
        
        /* 移动端菜单按钮 */
        .mobile-menu-btn {
            position: fixed;
            top: calc(10px + env(safe-area-inset-top));
            left: 16px;
            z-index: 101;
            border: 1px solid var(--primary-color);
            outline: none;
            background-color: transparent;
            padding: 10px 18px;
            border-radius: 30px;
            cursor: pointer;
            color: #ffffff;
            overflow: hidden;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 800;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, border-color 0.3s ease;
        }

        .mobile-menu-btn::before {
            content: "";
            position: absolute;
            top: 20%;
            left: 20%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            filter: blur(5px);
            z-index: -1;
            transition:
                width 0.9s ease-out,
                height 0.9s ease-out,
                background-color 0.3s ease-out;
            border-radius: 50%;
        }

        .mobile-menu-btn:hover::before {
            border-radius: 20px;
            width: 300px;
            height: 200px;
            background-color: var(--primary-color);
        }

        .mobile-menu-btn--visible {
            opacity: 1;
            pointer-events: auto;
        }

        body.dark-theme .mobile-menu-btn {
            border-color: var(--primary-light);
        }

        @media (min-width: 993px) {
            .mobile-menu-btn {
                display: none;
            }
        }

        /* 暗色主题 */
        body.dark-theme {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --text-light: #9ca3af;
            --primary-light: #3730a3;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }

        body.dark-theme .card {
            border: 1px solid #374151;
        }

        /* 以下为原有样式，保持不变... */
        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .card form,
        .card form .form-row,
        .card form .form-group,
        .filter-bar .form-group {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .form-row .form-group {
                min-width: 100%;
                max-width: 100%;
            }
            
            input:focus, select:focus, textarea:focus {
                box-shadow: none;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            max-width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
            box-sizing: border-box;
            -webkit-box-flex: 1;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--text-color);
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-normal {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-high {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-low {
            background-color: #fef3c7;
            color: #92400e;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            font-size: 1rem;
            padding: 4px;
            border-radius: 4px;
        }

        .action-btn:hover {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .chart-container {
            height: 300px;
            position: relative;
            margin-top: 20px;
        }

        .unit-toggle {
            display: flex;
            align-items: center;
            background-color: #f3f4f6;
            border-radius: var(--border-radius);
            padding: 4px;
            width: fit-content;
        }

        .unit-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .unit-btn.active {
            background-color: white;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .unit-toggle {
            background-color: #374151;
        }

        body.dark-theme .unit-btn {
            color: #e5e7eb;
        }

        body.dark-theme .unit-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .range-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-inputs input {
            width: 120px;
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.primary {
            background-color: var(--primary-color);
        }

        .stat-icon.success {
            background-color: var(--secondary-color);
        }

        .stat-icon.warning {
            background-color: var(--warning-color);
        }

        .stat-icon.danger {
            background-color: var(--danger-color);
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background-color: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }

        body.dark-theme .table-container {
            border-color: #374151;
        }

        body.dark-theme th {
            background-color: #374151;
        }

        body.dark-theme tr:hover {
            background-color: #374151;
        }

        body.dark-theme .action-btn {
            color: #9ca3af;
        }

        body.dark-theme .action-btn:hover {
            color: var(--primary-color);
            background-color: #3730a3;
        }

        .alert {
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }

        .alert i {
            font-size: 1.2rem;
        }

        body.dark-theme .alert-warning {
            background-color: #78350f;
            color: #fef3c7;
        }

        body.dark-theme .alert-danger {
            background-color: #7f1d1d;
            color: #fee2e2;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .advanced-panel {
            background-color: #f8fafc;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 24px;
            border-left: 4px solid var(--primary-color);
        }

        body.dark-theme .advanced-panel {
            background-color: #374151;
        }

        .advanced-panel h3 {
            margin-bottom: 16px;
            color: var(--text-color);
        }

        .advanced-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .personalization-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--border-radius);
            padding: 24px;
            color: white;
            margin-bottom: 24px;
        }

        .personalization-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .personalization-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .personalization-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .theme-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .theme-option {
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            color: white;
        }

        .theme-option:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .theme-option.active {
            background-color: white;
            color: #4f46e5;
            border-color: white;
        }

        .visualization-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .viz-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .viz-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .viz-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .target-progress {
            margin-top: 20px;
        }

        .progress-bar {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .notification-settings {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-label i {
            color: var(--primary-color);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .title-block.dashboard {
            background-color: #4f46e5;
        }
        .title-block.record {
            background-color: #10b981;
        }
        .title-block.history {
            background-color: #f59e0b;
        }
        .title-block.trend {
            background-color: #8b5cf6;
        }
        .title-block.personalization {
            background-color: #ec4899;
        }
        .title-block.settings {
            background-color: #6366f1;
        }
        .title-block.export {
            background-color: #14b8a6;
        }
        .title-block.sync {
            background-color: #06b6d4;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .option-group {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .option-group h3 {
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .sync-status {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sync-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 全局文本大小调整 */
        body {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }
            
            .header h2 {
                font-size: 1.4rem;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .stat-value {
                font-size: 1.6rem;
            }
            
            .btn {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            .header h2 {
                font-size: 1.2rem;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .stat-value {
                font-size: 1.4rem;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 12px;
            }
        }

        /* ==================== 云端同步优化样式 ==================== */
        /* 同步状态卡片样式 */
        .sync-status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .sync-stat-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #06b6d4;
        }

        .sync-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .sync-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #06b6d4, #0ea5e9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .sync-stat-content {
            flex: 1;
            min-width: 0;
        }

        .sync-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-color);
        }

        .sync-stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .sync-stat-detail {
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        /* 同步设置卡片 */
        .sync-settings-card {
            margin-bottom: 24px;
        }

        .sync-settings-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sync-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .sync-indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            display: inline-block;
        }

        .sync-indicator-dot.connected {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }

        .sync-indicator-dot.syncing {
            background-color: #f59e0b;
            animation: pulse 1s infinite;
        }

        .sync-indicator-dot.error {
            background-color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 同步设置组 */
        .sync-setting-group {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }

        body.dark-theme .sync-setting-group {
            background-color: #374151;
            border-color: #4b5563;
        }

        .sync-setting-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        body.dark-theme .sync-setting-header {
            border-bottom-color: #4b5563;
        }

        .sync-setting-header i {
            color: #06b6d4;
            font-size: 1.2rem;
        }

        .sync-setting-header h4 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        /* 同步开关组 */
        .sync-switch-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sync-switch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .sync-switch-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sync-switch-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .sync-switch-description {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* 同步方向选项 */
        .sync-direction-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sync-direction-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 10px;
            background-color: #f3f4f6;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        body.dark-theme .sync-direction-option {
            background-color: #374151;
        }

        .sync-direction-option:hover {
            border-color: #d1d5db;
        }

        .sync-direction-option.active {
            border-color: #06b6d4;
            background-color: #ecfeff;
        }

        body.dark-theme .sync-direction-option.active {
            background-color: #164e63;
            border-color: #06b6d4;
        }

        .direction-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: linear-gradient(135deg, #06b6d4, #0ea5e9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .direction-content {
            flex: 1;
        }

        .direction-content h5 {
            margin: 0 0 4px 0;
            font-size: 1rem;
            color: var(--text-color);
        }

        .direction-content p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .direction-check {
            color: #06b6d4;
            font-size: 1.2rem;
            opacity: 0;
        }

        .sync-direction-option.active .direction-check {
            opacity: 1;
        }

        /* 同步频率选择 */
        .sync-frequency-select {
            width: 200px;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background-color: white;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        body.dark-theme .sync-frequency-select {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        .sync-hint {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* 冲突处理选项 */
        .sync-conflict-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .conflict-option {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            background-color: var(--card-bg);
        }

        body.dark-theme .conflict-option {
            border-color: #4b5563;
        }

        .conflict-option.selected {
            border-color: #06b6d4;
            background-color: #ecfeff;
            box-shadow: 0 0 0 1px #06b6d4;
        }

        body.dark-theme .conflict-option.selected {
            background-color: rgba(6, 182, 212, 0.15);
        }

        .conflict-option-label {
            display: flex;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            width: 100%;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .conflict-option-label input[type="radio"] {
            margin-right: 16px;
            width: 20px;
            height: 20px;
            accent-color: #06b6d4;
            flex-shrink: 0;
        }

        .conflict-option-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .conflict-option-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .conflict-option-description {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.4;
        }
        
        /* 移动端适配优化 */
        @media (max-width: 768px) {
            .conflict-option-label {
                padding: 14px;
            }
            
            .conflict-option-title {
                font-size: 0.95rem;
            }
            
            .conflict-option-description {
                font-size: 0.8rem;
            }
        }

        /* 同步操作按钮 */
        .sync-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        body.dark-theme .sync-actions {
            border-top-color: #4b5563;
        }

        /* 同步日志 */
        .sync-log-card {
            margin-bottom: 24px;
        }

        .sync-log-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }

        body.dark-theme .sync-log-container {
            background-color: #1f2937;
            border-color: #374151;
        }

        .sync-log-list {
            padding: 16px;
        }

        .sync-log-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background-color: white;
            border-left: 4px solid #9ca3af;
        }

        body.dark-theme .sync-log-item {
            background-color: #374151;
        }

        .sync-log-item.success {
            border-left-color: #10b981;
        }

        .sync-log-item.error {
            border-left-color: #ef4444;
        }

        .sync-log-item.info {
            border-left-color: #06b6d4;
        }

        .sync-log-item.warning {
            border-left-color: #f59e0b;
        }

        .log-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sync-log-item.success .log-icon {
            background-color: #d1fae5;
            color: #10b981;
        }

        .sync-log-item.error .log-icon {
            background-color: #fee2e2;
            color: #ef4444;
        }

        .sync-log-item.info .log-icon {
            background-color: #e0f2fe;
            color: #06b6d4;
        }

        .sync-log-item.warning .log-icon {
            background-color: #fef3c7;
            color: #f59e0b;
        }

        body.dark-theme .sync-log-item.success .log-icon {
            background-color: #064e3b;
            color: #34d399;
        }

        body.dark-theme .sync-log-item.error .log-icon {
            background-color: #7f1d1d;
            color: #f87171;
        }

        body.dark-theme .sync-log-item.info .log-icon {
            background-color: #164e63;
            color: #22d3ee;
        }

        body.dark-theme .sync-log-item.warning .log-icon {
            background-color: #78350f;
            color: #fbbf24;
        }

        .log-content {
            flex: 1;
            min-width: 0;
        }

        .log-message {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .log-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .sync-log-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .sync-log-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
<script>
    (function() {
        var savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
        } else if (savedTheme === 'system') {
            var systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (systemDark) {
                document.body.classList.add('dark-theme');
            }
        }
    })();
</script>
    <!-- 加载动画 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- 侧边栏遮罩 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- 侧边栏 -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>血糖管理系统</h1>
            <p>LiuTwoFire Health</p>
        </div>
        
        <nav class="sidebar-nav">
            <a class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>数据仪表板</span>
            </a>
            <a class="nav-item" data-section="record">
                <i class="fas fa-plus-circle"></i>
                <span>录入血糖记录</span>
            </a>
            <a class="nav-item" data-section="history">
                <i class="fas fa-history"></i>
                <span>历史记录查看</span>
            </a>
            <a class="nav-item" data-section="trend">
                <i class="fas fa-chart-area"></i>
                <span>本周趋势分析</span>
            </a>
            <a class="nav-item" data-section="personalization">
                <i class="fas fa-palette"></i>
                <span>个性化设置</span>
            </a>
            <a class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>血糖值设置</span>
            </a>
            <a class="nav-item" data-section="export">
                <i class="fas fa-file-export"></i>
                <span>数据导出</span>
            </a>
            <a class="nav-item" data-section="sync">
                <i class="fas fa-cloud"></i>
                <span>云端同步</span>
            </a>
        </nav>
        
        <div class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
            <span>暗色主题</span>
        </div>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content" id="mainContent">
        <div id="alertContainer"></div>
        <!-- 仪表板 -->
        <section id="dashboard" class="content-section active">
            <div class="header">
                <div class="section-title">
                    <div class="title-block dashboard"></div>
                    <h2>血糖数据仪表板</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="userAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="userAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="userName">LiuTwoFire</div>
                            <div class="user-status" id="userStatus">坚持控制血糖，远离并发症</div>
                        </div>
                    </div>
                    <div class="unit-toggle">
                        <button class="unit-btn" id="unitMgdl">mg/dL</button>
                        <button class="unit-btn active" id="unitMmol">mmol/L</button>
                    </div>
                    <button class="btn btn-primary" id="addNewBtn">
                        <i class="fas fa-plus"></i>
                        <span>新增记录</span>
                    </button>
                </div>
            </div>

            <!-- 快速统计 -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="latestGlucose">--</div>
                        <div class="stat-label">最新血糖值 (<span id="currentUnit">mmol/L</span>)</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="todayAvg">--</div>
                        <div class="stat-label">今日平均血糖</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="todayRecords">0</div>
                        <div class="stat-label">今日记录条数</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="targetProgress">0%</div>
                        <div class="stat-label">目标达成率</div>
                    </div>
                </div>
            </div>

            <!-- 可视化卡片 -->
            <div class="visualization-cards">
                <div class="viz-card">
                    <div class="viz-card-header">
                        <h3 class="viz-card-title">本周血糖趋势</h3>
                        <button class="btn btn-secondary" id="refreshChart">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="glucoseChart"></canvas>
                    </div>
                </div>
                
                <div class="viz-card">
                    <div class="viz-card-header">
                        <h3 class="viz-card-title">血糖状态分布</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 目标进度 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">本月血糖控制目标</h3>
                    <div id="targetStatus">进行中</div>
                </div>
                <div class="target-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-labels">
                        <span>0%</span>
                        <span id="progressText">本月目标达成率</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>

            <!-- 高级功能面板 -->
            <div class="advanced-panel">
                <h3>高级功能</h3>
                <div class="advanced-actions">
                    <button class="btn btn-success" id="exportCsvBtn">
                        <i class="fas fa-file-csv"></i>
                        <span>导出CSV</span>
                    </button>
                    <button class="btn btn-warning" id="setTargetBtn">
                        <i class="fas fa-bullseye"></i>
                        <span>设置目标范围</span>
                    </button>
                    <button class="btn btn-primary" id="syncDataBtn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>云端同步</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- 血糖记录录入 -->
        <section id="record" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block record"></div>
                    <h2>录入血糖记录</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="recordUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="recordUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="recordUserName">LiuTwoFire</div>
                            <div class="user-status">添加新记录</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="backToDashboardBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">填写血糖信息</h3>
                </div>
                
                <form id="glucoseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="glucoseValue">血糖值 *</label>
                            <input type="number" step="0.1" id="glucoseValue" required placeholder="例如: 6.5">
                            <p class="unit-hint" style="color: var(--text-light); font-size: 0.85rem; margin-top: 4px;">当前单位: <span id="formUnit">mmol/L</span></p>
                        </div>
                        
                        <div class="form-group">
                            <label for="measureDate">测量日期 *</label>
                            <input type="date" id="measureDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="measureTime">测量时间 *</label>
                            <input type="time" id="measureTime" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="measureType">测量类型 *</label>
                            <select id="measureType" required>
                                <option value="">请选择测量类型</option>
                                <option value="fasting">空腹</option>
                                <option value="post-meal-1h">餐后1小时</option>
                                <option value="post-meal-2h">餐后2小时</option>
                                <option value="random">随机测量</option>
                                <option value="before-meal">餐前</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="glucoseNotes">备注 (选填)</label>
                        <textarea id="glucoseNotes" rows="3" placeholder="例如：早餐后吃了水果，运动30分钟等"></textarea>
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            <span>保存记录</span>
                        </button>
                        <button type="reset" class="btn btn-secondary" style="flex: 1; margin-left: 12px;">
                            <i class="fas fa-reset"></i>
                            <span>重置表单</span>
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- 历史记录查看 -->
        <section id="history" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block history"></div>
                    <h2>血糖历史记录</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="historyUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="historyUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="historyUserName">LiuTwoFire</div>
                            <div class="user-status">查看历史数据</div>
                        </div>
                    </div>
                    <div class="unit-toggle">
                        <button class="unit-btn" id="historyUnitMgdl">mg/dL</button>
                        <button class="unit-btn active" id="historyUnitMmol">mmol/L</button>
                    </div>
                    <button class="btn btn-secondary" id="historyBackBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <!-- 筛选栏 -->
            <div class="filter-bar">
                <div class="form-group">
                    <label for="filterDateFrom">开始日期</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="form-group">
                    <label for="filterDateTo">结束日期</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="form-group">
                    <label for="filterType">测量类型</label>
                    <select id="filterType">
                        <option value="">全部类型</option>
                        <option value="fasting">空腹</option>
                        <option value="post-meal-1h">餐后1小时</option>
                        <option value="post-meal-2h">餐后2小时</option>
                        <option value="random">随机测量</option>
                        <option value="before-meal">餐前</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" id="filterBtn" style="width: 100%;">
                        <i class="fas fa-filter"></i>
                        <span>筛选</span>
                    </button>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" id="resetFilterBtn" style="width: 100%;">
                        <i class="fas fa-sync-alt"></i>
                        <span>重置</span>
                    </button>
                </div>
            </div>

            <!-- 记录表格 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">血糖记录列表</h3>
                    <div style="color: var(--text-light); font-size: 0.9rem;" id="recordCount">共 0 条记录</div>
                </div>
                <div class="table-container">
                    <table id="glucoseTable">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>时间</th>
                                <th>测量类型</th>
                                <th>血糖值 (<span id="tableUnit">mmol/L</span>)</th>
                                <th>状态</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="glucoseTableBody">
                            <tr class="empty-state">
                                <td colspan="7">
                                    <i class="fas fa-database"></i>
                                    <p>暂无血糖记录</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 本周趋势分析 -->
        <section id="trend" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block trend"></div>
                    <h2>本周血糖趋势分析</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="trendUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="trendUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="trendUserName">LiuTwoFire</div>
                            <div class="user-status">分析血糖变化趋势</div>
                        </div>
                    </div>
                    <div class="unit-toggle">
                        <button class="unit-btn" id="trendUnitMgdl">mg/dL</button>
                        <button class="unit-btn active" id="trendUnitMmol">mmol/L</button>
                    </div>
                    <button class="btn btn-secondary" id="trendBackBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <!-- 趋势统计 -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="weekMax">--</div>
                        <div class="stat-label">本周最高血糖</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="weekMin">--</div>
                        <div class="stat-label">本周最低血糖</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="weekAvg">--</div>
                        <div class="stat-label">本周平均血糖</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="weekAbnormal">0</div>
                        <div class="stat-label">本周异常次数</div>
                    </div>
                </div>
            </div>

            <!-- 趋势图表 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">本周血糖变化趋势</h3>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="downloadTrendChart">
                            <i class="fas fa-download"></i>
                            <span>下载图表</span>
                        </button>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="weekTrendChart"></canvas>
                </div>
            </div>

            <!-- 分析报告 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">血糖分析报告</h3>
                </div>
                <div id="trendReport" style="line-height: 1.6; color: var(--text-color);">
                    <p>系统将根据您的血糖数据生成智能分析报告，请确保有足够的记录数据。</p>
                    <ul style="margin: 10px 0 10px 20px;">
                        <li>空腹血糖是否在正常范围（7.0-9.0 mmol/L）内</li>
                        <li>餐后2小时血糖是否控制在7.8-11.0 mmol/L以下</li>
                        <li>血糖波动是否过大（单日波动超过3.0 mmol/L）</li>
                        <li>异常血糖出现的时间规律分析</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 个性化设置 -->
        <section id="personalization" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block personalization"></div>
                    <h2>个性化设置</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="personalUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="personalUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="personalUserName">LiuTwoFire</div>
                            <div class="user-status">自定义您的使用体验</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="personalBackBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <!-- 头像上传 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">个人资料设置</h3>
                </div>
                <div class="avatar-upload-container">
                    <div class="avatar-preview" id="avatarPreview">
                        <div class="avatar-initial">L</div>
                        <img id="avatarPreviewImg" src="" alt="头像预览">
                    </div>
                    <div class="avatar-upload-btn">
                        <label for="avatarUpload" class="avatar-upload-label">
                            <i class="fas fa-upload"></i>
                            <span>上传头像</span>
                        </label>
                        <input type="file" id="avatarUpload" class="avatar-upload-input" accept="image/*">
                        <button class="avatar-remove-btn" id="avatarRemoveBtn">
                            <i class="fas fa-trash"></i>
                            <span>移除头像</span>
                        </button>
                    </div>
                </div>
                
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userNameInput">用户名</label>
                            <input type="text" id="userNameInput" value="LiuTwoFire" placeholder="请输入您的昵称">
                        </div>
                        <div class="form-group">
                            <label for="userAge">年龄</label>
                            <input type="number" id="userAge" placeholder="请输入您的年龄">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userGender">性别</label>
                            <select id="userGender">
                                <option value="">请选择</option>
                                <option value="male">男</option>
                                <option value="female">女</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userHeight">身高 (cm)</label>
                            <input type="number" id="userHeight" placeholder="请输入您的身高">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userWeight">体重 (kg)</label>
                            <input type="number" id="userWeight" placeholder="请输入您的体重">
                        </div>
                        <div class="form-group">
                            <label for="userDiabeticType">糖尿病类型</label>
                            <select id="userDiabeticType">
                                <option value="">无</option>
                                <option value="type1">1型糖尿病</option>
                                <option value="type2">2型糖尿病</option>
                                <option value="gestational">妊娠期糖尿病</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                        <i class="fas fa-save"></i>
                        <span>保存个人资料</span>
                    </button>
                </form>
            </div>

            <!-- 主题设置 -->
            <div class="personalization-panel">
                <div class="personalization-header">
                    <h3 class="personalization-title">主题与显示设置</h3>
                </div>
                <div class="personalization-content">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 12px; display: block;">选择主题</label>
                        <div class="theme-options">
                            <div class="theme-option active" data-theme="light">
                                <i class="fas fa-sun"></i>
                                <span>浅色主题</span>
                            </div>
                            <div class="theme-option" data-theme="dark">
                                <i class="fas fa-moon"></i>
                                <span>暗色主题</span>
                            </div>
                            <div class="theme-option" data-theme="system">
                                <i class="fas fa-desktop"></i>
                                <span>跟随系统</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="notification-settings">
                        <h4 style="margin-bottom: 16px; color: white;">通知设置</h4>
                        <div class="notification-item">
                            <div class="notification-label">
                                <i class="fas fa-bell"></i>
                                <span>血糖异常提醒</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="notifyAbnormal" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="notification-item">
                            <div class="notification-label">
                                <i class="fas fa-calendar-check"></i>
                                <span>每日记录提醒</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="notifyRecord" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="notification-item">
                            <div class="notification-label">
                                <i class="fas fa-sync-alt"></i>
                                <span>同步完成提醒</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="notifySync">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 血糖值设置 -->
        <section id="settings" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block settings"></div>
                    <h2>血糖值范围设置</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="settingsUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="settingsUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="settingsUserName">LiuTwoFire</div>
                            <div class="user-status">自定义血糖参考范围</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="settingsBackBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">血糖正常范围设置</h3>
                </div>
                
                <form id="rangeForm">
                    <div class="form-group">
                        <label>空腹血糖正常范围 (<span id="rangeUnit">mmol/L</span>)</label>
                        <div class="range-inputs">
                            <input type="number" step="0.1" id="fastingMin" value="7.0" placeholder="最小值">
                            <span>-</span>
                            <input type="number" step="0.1" id="fastingMax" value="9.0" placeholder="最大值">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>餐后2小时血糖正常范围 (<span id="rangeUnit2">mmol/L</span>)</label>
                        <div class="range-inputs">
                            <input type="number" step="0.1" id="postMealMin" value="7.8" placeholder="最小值">
                            <span>-</span>
                            <input type="number" step="0.1" id="postMealMax" value="11.0" placeholder="最大值">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>随机血糖正常范围 (<span id="rangeUnit3">mmol/L</span>)</label>
                        <div class="range-inputs">
                            <input type="number" step="0.1" id="randomMin" value="7.0" placeholder="最小值">
                            <span>-</span>
                            <input type="number" step="0.1" id="randomMax" value="11.1" placeholder="最大值">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetAvg">月度控制目标 (平均血糖值)</label>
                        <input type="number" step="0.1" id="targetAvg" value="8.5" placeholder="例如: 6.5">
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            <span>保存设置</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetRangeBtn" style="flex: 1; margin-left: 12px;">
                            <i class="fas fa-undo"></i>
                            <span>恢复默认</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">数据管理</h3>
                </div>
                <div style="padding: 20px 0;">
                    <button class="btn btn-warning" id="exportAllBtn" style="margin-right: 12px; margin-bottom: 12px;">
                        <i class="fas fa-file-export"></i>
                        <span>导出所有数据</span>
                    </button>
                    <button class="btn btn-secondary" id="importDataBtn" style="margin-bottom: 12px;">
                        <i class="fas fa-file-import"></i>
                        <span>导入数据</span>
                    </button>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button class="btn btn-danger" id="clearDataBtn">
                            <i class="fas fa-trash-alt"></i>
                            <span>清空所有数据</span>
                        </button>
                        <p style="color: var(--text-light); font-size: 0.85rem; margin-top: 8px;">
                            警告：此操作将删除所有血糖记录，且无法恢复！
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数据导出 -->
        <section id="export" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block export"></div>
                    <h2>数据导出</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="exportUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="exportUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="exportUserName">LiuTwoFire</div>
                            <div class="user-status">导出您的血糖数据</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="exportBackBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">导出设置</h3>
                </div>
                <div class="export-options">
                    <div class="option-group">
                        <h3>导出范围</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exportDateFrom">开始日期</label>
                                <input type="date" id="exportDateFrom">
                            </div>
                            <div class="form-group">
                                <label for="exportDateTo">结束日期</label>
                                <input type="date" id="exportDateTo">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="exportType">数据类型</label>
                            <select id="exportType">
                                <option value="all">所有数据</option>
                                <option value="fasting">仅空腹血糖</option>
                                <option value="post-meal">仅餐后血糖</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <h3>导出格式</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="exportCsvBtn2">
                                <i class="fas fa-file-csv"></i>
                                <span>导出为CSV</span>
                            </button>
                            <button class="btn btn-success" id="exportExcelBtn">
                                <i class="fas fa-file-excel"></i>
                                <span>导出为Excel</span>
                            </button>
                            <button class="btn btn-secondary" id="exportPdfBtn">
                                <i class="fas fa-file-pdf"></i>
                                <span>导出为PDF</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <h3>导出选项</h3>
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <input type="checkbox" id="exportWithChart" checked style="width: auto; margin-right: 8px;">
                            <label for="exportWithChart" style="margin-bottom: 0;">包含趋势图表 (仅PDF)</label>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <input type="checkbox" id="exportWithAnalysis" checked style="width: auto; margin-right: 8px;">
                            <label for="exportWithAnalysis" style="margin-bottom: 0;">包含数据分析 (仅PDF)</label>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="exportUnitMgdl" style="width: auto; margin-right: 8px;">
                            <label for="exportUnitMgdl" style="margin-bottom: 0;">使用mg/dL单位</label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 云端同步 -->
        <section id="sync" class="content-section">
            <div class="header">
                <div class="section-title">
                    <div class="title-block sync"></div>
                    <h2>云端同步</h2>
                </div>
                <div class="header-actions">
                    <div class="user-panel">
                        <div class="user-avatar" id="syncUserAvatar">
                            <div class="avatar-initial">L</div>
                            <img id="syncUserAvatarImg" src="" alt="用户头像">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="syncUserName">LiuTwoFire</div>
                            <div class="user-status">同步您的血糖数据</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="syncBackBtn">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                    </button>
                </div>
            </div>

            <!-- 同步状态卡片 -->
            <div class="sync-status-cards">
                <div class="sync-stat-card">
                    <div class="sync-stat-icon">
                        <i class="fas fa-cloud"></i>
                    </div>
                    <div class="sync-stat-content">
                        <div class="sync-stat-value" id="syncedRecords">0</div>
                        <div class="sync-stat-label">云端记录数</div>
                        <div class="sync-stat-detail" id="lastSyncTime">最后同步：从未</div>
                    </div>
                </div>
                
                <div class="sync-stat-card">
                    <div class="sync-stat-icon">
                        <i class="fas fa-laptop"></i>
                    </div>
                    <div class="sync-stat-content">
                        <div class="sync-stat-value" id="localRecords">0</div>
                        <div class="sync-stat-label">本地记录数</div>
                        <div class="sync-stat-detail">待同步：<span id="pendingSync">0</span> 条</div>
                    </div>
                </div>
                
                <div class="sync-stat-card">
                    <div class="sync-stat-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="sync-stat-content">
                        <div class="sync-stat-value" id="syncStatus">未连接</div>
                        <div class="sync-stat-label">同步状态</div>
                        <div class="sync-stat-detail" id="syncIndicator">
                            <span class="sync-indicator-dot"></span>
                            <span>等待连接</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 同步设置 -->
            <div class="card sync-settings-card">
                <div class="card-header">
                    <h3 class="card-title">同步设置</h3>
                    <div class="sync-status-indicator">
                        <span class="sync-indicator-dot" id="connectionStatus"></span>
                        <span id="connectionText">未连接到云端</span>
                    </div>
                </div>
                
                <div class="sync-settings-content">
                    <div class="sync-setting-group">
                        <div class="sync-setting-header">
                            <i class="fas fa-toggle-on"></i>
                            <h4>同步开关</h4>
                        </div>
                        <div class="sync-switch-group">
                            <div class="sync-switch-item">
                                <div class="sync-switch-label">
                                    <div class="sync-switch-title">自动同步</div>
                                    <div class="sync-switch-description">每次添加记录后自动同步到云端</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="autoSyncToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="sync-switch-item">
                                <div class="sync-switch-label">
                                    <div class="sync-switch-title">仅在WiFi下同步</div>
                                    <div class="sync-switch-description">避免使用移动数据进行同步</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="wifiOnlySync" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="sync-switch-item">
                                <div class="sync-switch-label">
                                    <div class="sync-switch-title">同步历史数据</div>
                                    <div class="sync-switch-description">将本地历史数据同步到云端</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="syncHistoryToggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sync-setting-group">
                        <div class="sync-setting-header">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>同步方向</h4>
                        </div>
                        <div class="sync-direction-options">
                            <div class="sync-direction-option active" data-direction="two-way">
                                <div class="direction-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="direction-content">
                                    <h5>双向同步</h5>
                                    <p>本地和云端数据相互同步，保持一致</p>
                                </div>
                                <div class="direction-check">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            
                            <div class="sync-direction-option" data-direction="local-to-cloud">
                                <div class="direction-icon">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <div class="direction-content">
                                    <h5>本地到云端</h5>
                                    <p>仅将本地数据上传到云端</p>
                                </div>
                                <div class="direction-check">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            
                            <div class="sync-direction-option" data-direction="cloud-to-local">
                                <div class="direction-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="direction-content">
                                    <h5>云端到本地</h5>
                                    <p>仅从云端下载数据到本地</p>
                                </div>
                                <div class="direction-check">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sync-setting-group">
                        <div class="sync-setting-header">
                            <i class="fas fa-clock"></i>
                            <h4>同步频率</h4>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label for="syncFrequency">自动同步间隔</label>
                            <select id="syncFrequency" class="sync-frequency-select">
                                <option value="immediate">立即同步</option>
                                <option value="5min">5分钟</option>
                                <option value="15min">15分钟</option>
                                <option value="30min">30分钟</option>
                                <option value="1hour">1小时</option>
                                <option value="6hour">6小时</option>
                                <option value="1day">1天</option>
                            </select>
                            <p class="sync-hint">选择"立即同步"将在数据变更时立即同步</p>
                        </div>
                    </div>
                    
                    <div class="sync-setting-group">
                        <div class="sync-setting-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h4>冲突处理</h4>
                        </div>
                        <div class="sync-conflict-options">
            <div class="conflict-option">
                <label class="conflict-option-label">
                    <input type="radio" name="conflict" value="local">
                    <div class="conflict-option-content">
                        <div class="conflict-option-title">以本地数据为准</div>
                        <div class="conflict-option-description">发生冲突时，使用本地数据覆盖云端数据</div>
                    </div>
                </label>
            </div>
                            
                            <div class="conflict-option">
                                <label class="conflict-option-label">
                                    <input type="radio" name="conflict" value="cloud">
                                    <div class="conflict-option-content">
                                        <div class="conflict-option-title">以云端数据为准</div>
                                        <div class="conflict-option-description">发生冲突时，使用云端数据覆盖本地数据</div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="conflict-option">
                                <label class="conflict-option-label">
                    <input type="radio" name="conflict" value="newest" checked>
                                    <div class="conflict-option-content">
                                        <div class="conflict-option-title">以最新数据为准</div>
                                        <div class="conflict-option-description">发生冲突时，使用时间戳较新的数据</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sync-actions">
                        <button class="btn btn-primary" id="manualSyncBtn">
                            <i class="fas fa-sync-alt"></i>
                            <span>立即同步</span>
                        </button>
                        <button class="btn btn-success" id="connectCloudBtn">
                            <i class="fas fa-cloud-connect"></i>
                            <span>连接云端</span>
                        </button>
                        <button class="btn btn-warning" id="disconnectCloudBtn">
                            <i class="fas fa-cloud-disconnect"></i>
                            <span>断开连接</span>
                        </button>
                        <button class="btn btn-danger" id="clearCloudBtn">
                            <i class="fas fa-trash-alt"></i>
                            <span>清空云端数据</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 同步日志 -->
            <div class="card sync-log-card">
                <div class="card-header">
                    <h3 class="card-title">同步日志</h3>
                    <button class="btn btn-secondary" id="clearLogBtn">
                        <i class="fas fa-broom"></i>
                        <span>清空日志</span>
                    </button>
                </div>
                <div class="sync-log-container">
                    <div class="sync-log-list" id="syncLogList">
                        <div class="sync-log-empty">
                            <i class="fas fa-file-alt"></i>
                            <p>暂无同步日志</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- JavaScript 交互逻辑 -->
    <script>
        // Firebase 云端同步配置与状态
        const firebaseConfig = {
            apiKey: "AIzaSyCliFpgd9s25NMnN9aC_zcUVEa_LYXsclo",
            authDomain: "laptop-repair-system-ab5cb.firebaseapp.com",
            databaseURL: "https://laptop-repair-system-ab5cb-default-rtdb.firebaseio.com",
            projectId: "laptop-repair-system-ab5cb",
            storageBucket: "laptop-repair-system-ab5cb.firebasestorage.app",
            messagingSenderId: "346945019586",
            appId: "1:346945019586:web:16314750732c9f859b655b"
        };

        let firebaseApp = null;
        let firebaseDatabase = null;
        let firebaseAuth = null;
        let cloudDataRef = null;
        let cloudSettingsRef = null;
        let firebaseUser = null;
        let cloudConnected = false;
        let cloudRecordCount = 0;
        let autoConnectAttempts = 0;

        // 全局变量
        let glucoseData = JSON.parse(localStorage.getItem('glucoseData')) || [];
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: 'LiuTwoFire',
            avatar: '',
            age: '',
            gender: '',
            height: '',
            weight: '',
            diabeticType: ''
        };
        let glucoseRanges = JSON.parse(localStorage.getItem('glucoseRanges')) || {
            fasting: { min: 3.9, max: 6.1 },
            postMeal: { min: 3.9, max: 7.8 },
            random: { min: 3.9, max: 11.1 },
            targetAvg: 6.5
        };
        let currentUnit = 'mmol/L'; // 默认单位
        let theme = localStorage.getItem('theme') || 'light';
        let editingRecordId = null;
        
        // 图表实例
        let glucoseChartInstance = null;
        let statusChartInstance = null;
        let weekTrendChartInstance = null;

        // Firebase 初始化与云端同步逻辑
        async function ensureFirebaseReady() {
            try {
                // 已初始化则直接复用
                if (!firebaseApp) {
                    firebaseApp = (firebase.apps && firebase.apps.length)
                        ? firebase.app()
                        : firebase.initializeApp(firebaseConfig);
                }
                firebaseDatabase = firebaseDatabase || firebase.database();
                firebaseAuth = firebaseAuth || firebase.auth();
                return true;
            } catch (error) {
                console.error('Firebase 初始化失败', error);
                addSyncLog('Firebase 初始化失败：' + (error.message || error), 'error');
                showAlert('Firebase 初始化失败，请检查网络或配置', 'error');
                return false;
            }
        }

        function updateConnectionUI(connected, text = '') {
            const statusDot = document.getElementById('connectionStatus');
            const connectionText = document.getElementById('connectionText');
            const syncStatus = document.getElementById('syncStatus');
            const syncIndicator = document.getElementById('syncIndicator');

            if (!statusDot || !connectionText || !syncStatus || !syncIndicator) return;

            if (connected) {
                statusDot.classList.add('connected');
                connectionText.textContent = text || '已连接到云端';
                syncStatus.textContent = '已连接';
                syncIndicator.innerHTML = '<span class="sync-indicator-dot connected"></span><span>已连接</span>';
            } else {
                statusDot.classList.remove('connected');
                connectionText.textContent = text || '未连接到云端';
                syncStatus.textContent = '未连接';
                syncIndicator.innerHTML = '<span class="sync-indicator-dot"></span><span>等待连接</span>';
            }
        }

        function getConflictStrategy() {
            const checked = document.querySelector('input[name="conflict"]:checked');
            return checked ? checked.value : 'newest';
        }

        function mergeCloudAndLocal(cloudRecords) {
            const strategy = getConflictStrategy();
            if (strategy === 'local') return [...glucoseData];
            return [...cloudRecords];
        }

        // 实时监听云端数据变化
        let realtimeListener = null;
        let isSyncing = false; // 同步标志，防止循环同步
        
        function setupRealtimeListener() {
            if (!cloudDataRef || realtimeListener) return;
            
            realtimeListener = cloudDataRef.on('value', (snapshot) => {
                // 如果正在同步，忽略此次更新（避免循环）
                if (isSyncing) return;
                
                const data = snapshot.val() || {};
                const cloudRecords = Object.values(data);
                cloudRecordCount = cloudRecords.length;

                // 合并云端和本地数据
                const mergedRecords = mergeCloudAndLocal(cloudRecords).sort((a, b) => {
                    const timeA = new Date(a.createTime || a.id || 0).getTime();
                    const timeB = new Date(b.createTime || b.id || 0).getTime();
                    return timeB - timeA;
                });

                // 只有在数据真正变化时才更新（避免循环同步）
                const currentDataStr = JSON.stringify(glucoseData.map(r => r.id).sort());
                const newDataStr = JSON.stringify(mergedRecords.map(r => r.id).sort());
                
                if (currentDataStr !== newDataStr) {
                    glucoseData = mergedRecords;
                    localStorage.setItem('glucoseData', JSON.stringify(glucoseData));

                    updateDashboardStats();
                    updateHistoryTable();
                    updateTrendStats();
                    initCharts();
                    updateSyncStats(new Date());

                    addSyncLog(`云端数据已更新，共 ${cloudRecordCount} 条记录`, 'info');
                }
            }, (error) => {
                console.error('实时监听错误:', error);
                addSyncLog('实时同步错误：' + (error.message || error), 'error');
            });
            
            addSyncLog('已启用实时同步监听', 'info');
        }
        
        function removeRealtimeListener() {
            if (realtimeListener && cloudDataRef) {
                cloudDataRef.off('value', realtimeListener);
                realtimeListener = null;
            }
        }

        async function loadCloudDataFromFirebase() {
            if (!cloudDataRef) return;

            try {
                // 载入设置
                if (cloudSettingsRef) {
                    const settingsSnapshot = await cloudSettingsRef.once('value');
                    const settings = settingsSnapshot.val();
                    if (settings) {
                        // 血糖范围设置
                        if (settings.glucoseRanges) {
                            glucoseRanges = settings.glucoseRanges;
                            localStorage.setItem('glucoseRanges', JSON.stringify(glucoseRanges));
                            
                            // 更新设置UI
                            const rangeInputs = {
                                'fastingMin': glucoseRanges.fasting.min,
                                'fastingMax': glucoseRanges.fasting.max,
                                'postMealMin': glucoseRanges.postMeal.min,
                                'postMealMax': glucoseRanges.postMeal.max,
                                'randomMin': glucoseRanges.random.min,
                                'randomMax': glucoseRanges.random.max,
                                'targetAvg': glucoseRanges.targetAvg
                            };
                            
                            Object.entries(rangeInputs).forEach(([id, value]) => {
                                const el = document.getElementById(id);
                                if (el) el.value = value;
                            });
                        }
                        
                        // 用户资料
                        if (settings.userProfile) {
                            userProfile = settings.userProfile;
                            localStorage.setItem('userProfile', JSON.stringify(userProfile));
                            initUserProfile();
                        }
                        
                        // 单位设置
                        if (settings.currentUnit) {
                            currentUnit = settings.currentUnit;
                            updateUnitDisplay();
                        }
                        
                        const localTheme = localStorage.getItem('theme');
                        if (!localTheme && settings.theme) {
                            theme = settings.theme;
                            localStorage.setItem('theme', theme);
                            if (theme === 'dark') document.body.classList.add('dark-theme');
                            else if (theme === 'light') document.body.classList.remove('dark-theme');
                            
                            document.querySelectorAll('.theme-option').forEach(option => {
                                option.classList.remove('active');
                                if (option.dataset.theme === theme) option.classList.add('active');
                            });
                        }
                        
                        addSyncLog('已从云端同步个性化设置', 'success');
                    }
                }
            } catch (error) {
                console.warn('载入设置失败:', error);
                addSyncLog('同步设置失败，使用本地配置', 'warning');
            }

            const snapshot = await cloudDataRef.once('value');
            const data = snapshot.val() || {};
            const cloudRecords = Object.values(data);
            cloudRecordCount = cloudRecords.length;

            const mergedRecords = mergeCloudAndLocal(cloudRecords).sort((a, b) => {
                const timeA = new Date(a.createTime || a.id || 0).getTime();
                const timeB = new Date(b.createTime || b.id || 0).getTime();
                return timeB - timeA;
            });

            glucoseData = mergedRecords;
            localStorage.setItem('glucoseData', JSON.stringify(glucoseData));

            updateDashboardStats();
            updateHistoryTable();
            updateTrendStats();
            initCharts();
            updateSyncStats(new Date());

            addSyncLog(`已从云端载入 ${cloudRecordCount} 条记录`, 'success');
        }

        async function syncLocalToCloud() {
            if (!cloudConnected) {
                await connectCloud();
                if (!cloudConnected) return;
            }

            // 设置同步标志，避免实时监听触发循环
            isSyncing = true;
            
            try {
                // 同步设置到云端
                if (cloudSettingsRef) {
                    const settings = {
                        glucoseRanges: glucoseRanges,
                        userProfile: userProfile,
                        currentUnit: currentUnit,
                        theme: theme,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    };
                    cloudSettingsRef.update(settings).catch(e => console.warn('同步设置失败:', e));
                }

                await cloudDataRef.transaction(() => {
                    const nextData = {};
                    glucoseData.forEach(item => {
                        if (!item || item.id == null) return;
                        nextData[item.id] = item;
                    });
                    return nextData;
                });
                
                cloudRecordCount = glucoseData.length;
                updateSyncStats(new Date());
                addSyncLog(`同步成功，共同步 ${cloudRecordCount} 条记录`, 'success');
            } catch (error) {
                addSyncLog('同步失败：' + (error.message || error), 'error');
                showAlert('同步失败：' + (error.message || error), 'error');
            } finally {
                // 恢复监听
                isSyncing = false;
            }
        }

        async function connectCloud() {
            const ready = await ensureFirebaseReady();
            if (!ready) return;

            try {
                const credential = await firebaseAuth.signInAnonymously();
                firebaseUser = credential.user;
                // 使用共享路径，所有设备访问同一数据集
                cloudDataRef = firebaseDatabase.ref('glucoseRecords');
                cloudSettingsRef = firebaseDatabase.ref('userSettings');
                cloudConnected = true;
                updateConnectionUI(true, '已连接到云端');
                addSyncLog('匿名登录成功，正在同步数据', 'info');
                
                // 首次加载数据
                await loadCloudDataFromFirebase();
                
                // 自动同步一次，确保本地设置（如首次使用）上传到云端
                await syncLocalToCloud();
                
                // 设置实时监听，当其他设备更新数据时自动同步
                setupRealtimeListener();
            } catch (error) {
                cloudConnected = false;
                updateConnectionUI(false, '未连接到云端');
                addSyncLog('连接云端失败：' + (error.message || error), 'error');
                showAlert('连接云端失败：' + (error.message || error), 'error');
            }
        }

        // 带加载提示的连接云端（可用于自动或手动）
        async function connectCloudWithLoading(auto = false) {
            showLoading();
            try {
                await connectCloud();
            } finally {
                hideLoading();
                if (auto && !cloudConnected) {
                    addSyncLog('自动连接云端失败，请手动重试', 'warning');
                }
            }
        }

        // 自动连接（用于移动端进入页面、网络恢复、页面前台）
        async function autoConnectIfNeeded(trigger = 'auto') {
            if (cloudConnected) return;
            if (autoConnectAttempts >= 3) return; // 避免无限重试
            autoConnectAttempts += 1;
            addSyncLog(`正在尝试自动连接云端（触发：${trigger}，第 ${autoConnectAttempts} 次）`, 'info');
            await connectCloudWithLoading(true);
        }

        async function disconnectCloud() {
            // 移除实时监听
            removeRealtimeListener();
            
            try {
                if (firebaseAuth) {
                    await firebaseAuth.signOut();
                }
            } catch (error) {
                console.warn('断开连接时出错', error);
            }
            cloudConnected = false;
            cloudDataRef = null;
            firebaseUser = null;
            updateConnectionUI(false, '已断开与云端的连接');
            updateSyncStats();
            addSyncLog('已断开云端连接', 'info');
        }

        async function clearCloudData() {
            if (!cloudConnected) {
                await connectCloud();
                if (!cloudConnected) return;
            }

            try {
                await cloudDataRef.remove();
                cloudRecordCount = 0;
                updateSyncStats(new Date());
                addSyncLog('云端数据已清空', 'warning');
            } catch (error) {
                addSyncLog('清空云端数据失败：' + (error.message || error), 'error');
                showAlert('清空云端数据失败：' + (error.message || error), 'error');
            }
        }

        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化主题
            initTheme();
            
            // 初始化单位
            initUnit();
            
            // 初始化用户资料
            initUserProfile();
            
            // 初始化血糖数据
            initGlucoseData();
            
            // 初始化图表
            initCharts();
            
            // 绑定事件
            bindEvents();

            // 初始化同步状态
            updateConnectionUI(false, '未连接到云端');
            updateSyncStats();

            // 页面加载后自动尝试连接并同步（保留手动按钮）
            autoConnectIfNeeded('page-load');

            // 网络恢复时自动重试
            window.addEventListener('online', () => autoConnectIfNeeded('online'));
            // 回到前台时自动重试（移动端常见场景）
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    autoConnectIfNeeded('visible');
                }
            });
            
            // 隐藏加载动画
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // 初始化主题
        function initTheme() {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.theme === 'dark') option.classList.add('active');
                });
            } else if (theme === 'system') {
                const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (systemDark) document.body.classList.add('dark-theme');
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.theme === 'system') option.classList.add('active');
                });
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        // 初始化单位
        function initUnit() {
            document.querySelectorAll('.unit-btn').forEach(btn => {
                if (btn.id.includes('mmol') && currentUnit === 'mmol/L') {
                    btn.classList.add('active');
                } else if (btn.id.includes('mgdl') && currentUnit === 'mg/dL') {
                    btn.classList.add('active');
                }
            });
            updateUnitDisplay();
        }

        // 初始化用户资料
        function initUserProfile() {
            // 更新所有用户头像
            document.querySelectorAll('.user-avatar').forEach(avatar => {
                const img = avatar.querySelector('img');
                const initial = avatar.querySelector('.avatar-initial');
                if (userProfile.avatar) {
                    img.src = userProfile.avatar;
                    avatar.classList.add('has-avatar');
                } else {
                    initial.textContent = userProfile.name.charAt(0).toUpperCase();
                    avatar.classList.remove('has-avatar');
                }
            });
            
            const avatarPreview = document.getElementById('avatarPreview');
            const avatarPreviewImg = document.getElementById('avatarPreviewImg');
            const avatarPreviewInitial = avatarPreview ? avatarPreview.querySelector('.avatar-initial') : null;
            if (avatarPreview && avatarPreviewImg && avatarPreviewInitial) {
                if (userProfile.avatar) {
                    avatarPreviewImg.src = userProfile.avatar;
                    avatarPreview.classList.add('has-avatar');
                } else {
                    avatarPreviewImg.src = '';
                    avatarPreview.classList.remove('has-avatar');
                    avatarPreviewInitial.textContent = userProfile.name.charAt(0).toUpperCase();
                }
            }
            
            // 更新用户名
            document.querySelectorAll('.user-name').forEach(el => {
                el.textContent = userProfile.name;
            });
            
            // 填充个人资料表单
            document.getElementById('userNameInput').value = userProfile.name;
            document.getElementById('userAge').value = userProfile.age || '';
            document.getElementById('userGender').value = userProfile.gender || '';
            document.getElementById('userHeight').value = userProfile.height || '';
            document.getElementById('userWeight').value = userProfile.weight || '';
            document.getElementById('userDiabeticType').value = userProfile.diabeticType || '';
        }

        // 初始化血糖数据
        function initGlucoseData() {
            updateDashboardStats();
            updateHistoryTable();
            updateTrendStats();
        }

        // 初始化图表
        function initCharts() {
            // 销毁旧图表实例
            if (glucoseChartInstance) {
                glucoseChartInstance.destroy();
                glucoseChartInstance = null;
            }
            if (statusChartInstance) {
                statusChartInstance.destroy();
                statusChartInstance = null;
            }
            if (weekTrendChartInstance) {
                weekTrendChartInstance.destroy();
                weekTrendChartInstance = null;
            }

            // 本周趋势图
            glucoseChartInstance = new Chart(
                document.getElementById('glucoseChart'),
                {
                    type: 'line',
                    data: {
                        labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                        datasets: [{
                            label: '血糖值 (' + currentUnit + ')',
                            data: [5.2, 5.8, 6.1, 5.9, 6.3, 5.7, 5.5],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 3
                            }
                        }
                    }
                }
            );

            // 计算状态分布数据
            let normalCount = 0;
            let highCount = 0;
            let lowCount = 0;

            if (glucoseData && glucoseData.length > 0) {
                glucoseData.forEach(item => {
                    const status = getGlucoseStatus(item.value, item.type);
                    if (status === '正常') normalCount++;
                    else if (status === '偏高') highCount++;
                    else if (status === '偏低') lowCount++;
                });
            } else {
                // 如果没有数据，默认全0或显示空状态
                // 这里为了美观，如果是空数据，可以给个灰色的或者保持0
            }

            // 状态分布饼图
            statusChartInstance = new Chart(
                document.getElementById('statusChart'),
                {
                    type: 'doughnut',
                    data: {
                        labels: ['正常', '偏高', '偏低'],
                        datasets: [{
                            data: [normalCount, highCount, lowCount],
                            backgroundColor: [
                                '#10b981',
                                '#ef4444',
                                '#f59e0b'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                }
            );

            // 本周趋势分析图
            weekTrendChartInstance = new Chart(
                document.getElementById('weekTrendChart'),
                {
                    type: 'line',
                    data: {
                        labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                        datasets: [{
                            label: '空腹血糖',
                            data: [5.1, 5.3, 5.5, 5.4, 5.6, 5.2, 5.0],
                            borderColor: '#4f46e5',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        }, {
                            label: '餐后2小时血糖',
                            data: [6.8, 7.1, 7.3, 6.9, 7.5, 7.0, 6.7],
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 3
                            }
                        }
                    }
                }
            );
        }

        // 绑定所有事件
        function bindEvents() {
            // 冲突处理选项交互
            const conflictInputs = document.querySelectorAll('input[name="conflict"]');
            
            function updateConflictUI() {
                conflictInputs.forEach(input => {
                    const optionDiv = input.closest('.conflict-option');
                    if (optionDiv) {
                        if (input.checked) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                    }
                });
            }
            
            conflictInputs.forEach(input => {
                input.addEventListener('change', updateConflictUI);
            });
            
            // 初始化冲突处理UI
            updateConflictUI();

            // 侧边栏导航切换
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.dataset.section;
                    
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');
                    
                    if (window.innerWidth <= 992) {
                        const sidebarEl = document.getElementById('sidebar');
                        const overlayEl = document.getElementById('sidebarOverlay');
                        if (sidebarEl) sidebarEl.classList.remove('active');
                        if (overlayEl) overlayEl.classList.remove('active');
                        document.body.style.overflow = '';
                        if (typeof updateMobileMenuVisibility === 'function') {
                            updateMobileMenuVisibility();
                        }
                    }
                });
            });

            // 移动端菜单按钮和遮罩层逻辑
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');

            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                updateMobileMenuVisibility();
            }

            mobileMenuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            function updateMobileMenuVisibility() {
                if (!mobileMenuBtn) return;
                const isMobile = window.innerWidth <= 992;
                const atTop = window.scrollY <= 10;
                const sidebarOpen = sidebar.classList.contains('active');
                if (isMobile && atTop && !sidebarOpen) {
                    mobileMenuBtn.classList.add('mobile-menu-btn--visible');
                } else {
                    mobileMenuBtn.classList.remove('mobile-menu-btn--visible');
                }
            }

            updateMobileMenuVisibility();
            window.addEventListener('scroll', updateMobileMenuVisibility);
            window.addEventListener('resize', updateMobileMenuVisibility);

            // 主题切换
            document.getElementById('themeToggle').addEventListener('click', function() {
                document.body.classList.toggle('dark-theme');
                theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                
                // 更新主题选项
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.theme === theme) option.classList.add('active');
                });
            });

            // 主题选项切换
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    theme = this.dataset.theme;
                    localStorage.setItem('theme', theme);
                    
                    if (theme === 'dark') {
                        document.body.classList.add('dark-theme');
                    } else if (theme === 'light') {
                        document.body.classList.remove('dark-theme');
                    } else {
                        // 跟随系统
                        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        if (systemDark) {
                            document.body.classList.add('dark-theme');
                        } else {
                            document.body.classList.remove('dark-theme');
                        }
                    }
                });
            });

            // 单位切换
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 切换单位
                    if (this.id.includes('mgdl')) {
                        currentUnit = 'mg/dL';
                    } else {
                        currentUnit = 'mmol/L';
                    }
                    
                    // 更新激活状态
                    document.querySelectorAll('.unit-btn').forEach(b => {
                        if ((b.id.includes('mgdl') && currentUnit === 'mg/dL') || 
                            (b.id.includes('mmol') && currentUnit === 'mmol/L')) {
                            b.classList.add('active');
                        } else {
                            b.classList.remove('active');
                        }
                    });
                    
                    // 更新单位显示
                    updateUnitDisplay();
                    
                    // 更新图表
                    initCharts();
                    
                    // 更新数据显示
                    updateDashboardStats();
                    updateHistoryTable();
                    updateTrendStats();
                });
            });

            // 表单提交
            document.getElementById('glucoseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const glucoseValue = parseFloat(document.getElementById('glucoseValue').value);
                const measureDate = document.getElementById('measureDate').value;
                const measureTime = document.getElementById('measureTime').value;
                const measureType = document.getElementById('measureType').value;
                const notes = document.getElementById('glucoseNotes').value;
                
                // 转换单位（存储为mmol/L）
                let value = glucoseValue;
                if (currentUnit === 'mg/dL') {
                    value = glucoseValue / 18;
                }
                
                if (editingRecordId !== null) {
                    const index = glucoseData.findIndex(item => item.id === editingRecordId);
                    if (index !== -1) {
                        const original = glucoseData[index];
                        glucoseData[index] = {
                            ...original,
                            value: value,
                            date: measureDate,
                            time: measureTime,
                            type: measureType,
                            notes: notes
                        };
                    }
                } else {
                    const newRecord = {
                        id: Date.now(),
                        value: value,
                        date: measureDate,
                        time: measureTime,
                        type: measureType,
                        notes: notes,
                        createTime: new Date().toISOString()
                    };
                    glucoseData.unshift(newRecord);
                }
                
                localStorage.setItem('glucoseData', JSON.stringify(glucoseData));
                
                // 自动同步到云端（如果已连接）
                if (cloudConnected) {
                    syncLocalToCloud().catch(err => {
                        console.warn('自动同步失败:', err);
                    });
                }
                
                editingRecordId = null;
                const submitBtn = this.querySelector('button[type="submit"] span');
                if (submitBtn) submitBtn.textContent = '保存记录';
                
                // 重置表单
                this.reset();
                document.getElementById('measureDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('measureTime').value = new Date().toTimeString().split(' ')[0].substring(0, 5);
                
                // 显示成功提示
                showAlert('记录保存成功！', 'success');
                
                // 更新数据
                updateDashboardStats();
                updateHistoryTable();
                updateTrendStats();
                initCharts();
                
                // 跳转到仪表板
                document.querySelector('.nav-item[data-section="dashboard"]').click();
            });

            // 个人资料表单提交
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 更新用户资料
                userProfile.name = document.getElementById('userNameInput').value;
                userProfile.age = document.getElementById('userAge').value;
                userProfile.gender = document.getElementById('userGender').value;
                userProfile.height = document.getElementById('userHeight').value;
                userProfile.weight = document.getElementById('userWeight').value;
                userProfile.diabeticType = document.getElementById('userDiabeticType').value;
                
                // 保存到本地存储
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                // 同步到云端
                if (cloudConnected) syncLocalToCloud().catch(console.warn);

                // 更新页面显示
                initUserProfile();
                
                // 显示成功提示
                showAlert('个人资料保存成功！', 'success');
            });

            // 头像上传
            document.getElementById('avatarUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        userProfile.avatar = event.target.result;
                        localStorage.setItem('userProfile', JSON.stringify(userProfile));
                        if (cloudConnected) syncLocalToCloud().catch(console.warn);
                        initUserProfile();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 移除头像
            document.getElementById('avatarRemoveBtn').addEventListener('click', function() {
                userProfile.avatar = '';
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                if (cloudConnected) syncLocalToCloud().catch(console.warn);
                initUserProfile();
            });

            // 血糖范围设置表单提交
            document.getElementById('rangeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 更新范围设置
                glucoseRanges.fasting.min = parseFloat(document.getElementById('fastingMin').value);
                glucoseRanges.fasting.max = parseFloat(document.getElementById('fastingMax').value);
                glucoseRanges.postMeal.min = parseFloat(document.getElementById('postMealMin').value);
                glucoseRanges.postMeal.max = parseFloat(document.getElementById('postMealMax').value);
                glucoseRanges.random.min = parseFloat(document.getElementById('randomMin').value);
                glucoseRanges.random.max = parseFloat(document.getElementById('randomMax').value);
                glucoseRanges.targetAvg = parseFloat(document.getElementById('targetAvg').value);
                
                // 保存到本地存储
                localStorage.setItem('glucoseRanges', JSON.stringify(glucoseRanges));
                
                // 同步到云端
                if (cloudConnected) syncLocalToCloud().catch(console.warn);
                
                // 显示成功提示
                showAlert('血糖范围设置保存成功！', 'success');
                
                // 更新数据
                updateDashboardStats();
                updateHistoryTable();
                initCharts();
            });

            // 重置范围设置
            document.getElementById('resetRangeBtn').addEventListener('click', function() {
                glucoseRanges = {
                    fasting: { min: 3.9, max: 6.1 },
                    postMeal: { min: 3.9, max: 7.8 },
                    random: { min: 3.9, max: 11.1 },
                    targetAvg: 6.5
                };
                
                // 更新表单
                document.getElementById('fastingMin').value = 3.9;
                document.getElementById('fastingMax').value = 6.1;
                document.getElementById('postMealMin').value = 3.9;
                document.getElementById('postMealMax').value = 7.8;
                document.getElementById('randomMin').value = 3.9;
                document.getElementById('randomMax').value = 11.1;
                document.getElementById('targetAvg').value = 6.5;
                
                // 保存到本地存储
                localStorage.setItem('glucoseRanges', JSON.stringify(glucoseRanges));
                
                // 同步到云端
                if (cloudConnected) syncLocalToCloud().catch(console.warn);
                
                // 显示提示
                showAlert('已恢复默认范围设置！', 'info');

                // 更新数据
                updateDashboardStats();
                updateHistoryTable();
                initCharts();
            });

            // 立即同步按钮
            document.getElementById('manualSyncBtn').addEventListener('click', async function() {
                showLoading();
                try {
                    await syncLocalToCloud();
                } finally {
                    hideLoading();
                }
            });

            // 连接云端按钮
            document.getElementById('connectCloudBtn').addEventListener('click', async function() {
                await connectCloudWithLoading();
            });

            // 断开云端按钮
            document.getElementById('disconnectCloudBtn').addEventListener('click', async function() {
                await disconnectCloud();
            });

            // 清空云端数据按钮
            document.getElementById('clearCloudBtn').addEventListener('click', async function() {
                showLoading();
                try {
                    await clearCloudData();
                } finally {
                    hideLoading();
                }
            });

            // 导出按钮事件
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const exportCsvBtn2 = document.getElementById('exportCsvBtn2');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const exportAllBtn = document.getElementById('exportAllBtn');
            
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', function() {
                    exportToCSV();
                });
            }
            if (exportCsvBtn2) {
                exportCsvBtn2.addEventListener('click', function() {
                    exportToCSV();
                });
            }
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', function() {
                    exportToExcel();
                });
            }
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function() {
                    exportToPDF();
                });
            }
            if (exportAllBtn) {
                exportAllBtn.addEventListener('click', function() {
                    exportToCSV();
                });
            }

            // 设置目标范围按钮
            const setTargetBtn = document.getElementById('setTargetBtn');
            if (setTargetBtn) {
                setTargetBtn.addEventListener('click', function() {
                    document.querySelector('.nav-item[data-section="settings"]').click();
                });
            }
            
            // 云端同步按钮
            const syncDataBtn = document.getElementById('syncDataBtn');
            if (syncDataBtn) {
                syncDataBtn.addEventListener('click', function() {
                    document.querySelector('.nav-item[data-section="sync"]').click();
                });
            }

            // 清空所有数据按钮
            const clearDataBtn = document.getElementById('clearDataBtn');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', function() {
                    if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                        glucoseData = [];
                        localStorage.setItem('glucoseData', JSON.stringify(glucoseData));
                        
                        // 自动同步到云端（如果已连接）
                        if (cloudConnected) {
                            syncLocalToCloud().catch(err => {
                                console.warn('自动同步失败:', err);
                            });
                        }
                        
                        updateDashboardStats();
                        updateHistoryTable();
                        updateTrendStats();
                        initCharts();
                        showAlert('所有数据已清空', 'success');
                    }
                });
            }

            const filterBtn = document.getElementById('filterBtn');
            if (filterBtn) {
                filterBtn.addEventListener('click', function() {
                    updateHistoryTable();
                });
            }

            const resetFilterBtn = document.getElementById('resetFilterBtn');
            if (resetFilterBtn) {
                resetFilterBtn.addEventListener('click', function() {
                    const dateFrom = document.getElementById('filterDateFrom');
                    const dateTo = document.getElementById('filterDateTo');
                    const typeSelect = document.getElementById('filterType');
                    if (dateFrom) dateFrom.value = '';
                    if (dateTo) dateTo.value = '';
                    if (typeSelect) typeSelect.value = '';
                    updateHistoryTable();
                });
            }

            document.querySelectorAll('[id$="BackBtn"], #backToDashboardBtn, #addNewBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.id === 'addNewBtn') {
                        editingRecordId = null;
                        const submitBtn = document.querySelector('#glucoseForm button[type="submit"] span');
                        if (submitBtn) submitBtn.textContent = '保存记录';
                        document.querySelector('.nav-item[data-section="record"]').click();
                        document.getElementById('measureDate').value = new Date().toISOString().split('T')[0];
                        document.getElementById('measureTime').value = new Date().toTimeString().split(' ')[0].substring(0, 5);
                    } else {
                        document.querySelector('.nav-item[data-section="dashboard"]').click();
                    }
                });
            });
        }

        // 更新单位显示
        function updateUnitDisplay() {
            document.querySelectorAll('#currentUnit, #formUnit, #tableUnit, #rangeUnit, #rangeUnit2, #rangeUnit3').forEach(el => {
                el.textContent = currentUnit;
            });
        }

        // 更新仪表板统计数据
        function updateDashboardStats() {
            if (glucoseData.length === 0) {
                document.getElementById('latestGlucose').textContent = '--';
                document.getElementById('todayAvg').textContent = '--';
                document.getElementById('todayRecords').textContent = '0';
                document.getElementById('targetProgress').textContent = '0%';
                document.getElementById('progressFill').style.width = '0%';
                return;
            }

            const latest = glucoseData[0].value;
            document.getElementById('latestGlucose').textContent = convertUnit(latest).toFixed(1);

            const today = new Date().toISOString().split('T')[0];
            const todayData = glucoseData.filter(item => item.date === today);
            document.getElementById('todayRecords').textContent = todayData.length;

            const todayAvg = todayData.length > 0
                ? todayData.reduce((sum, item) => sum + item.value, 0) / todayData.length
                : 0;
            document.getElementById('todayAvg').textContent = todayData.length > 0
                ? convertUnit(todayAvg).toFixed(1)
                : '--';

            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthData = glucoseData.filter(item => item.date && item.date.startsWith(currentMonth));

            let progress = 0;
            let monthAvg = null;

            if (monthData.length > 0) {
                const total = monthData.reduce((sum, item) => sum + item.value, 0);
                monthAvg = total / monthData.length;
                const target = parseFloat(glucoseRanges.targetAvg) || 0;

                if (target > 0 && monthAvg > 0) {
                    if (monthAvg <= target) {
                        progress = 100;
                    } else {
                        progress = (target / monthAvg) * 100;
                    }
                } else {
                    const normalCount = monthData.filter(item => getGlucoseStatus(item.value, item.type) === '正常').length;
                    progress = (normalCount / monthData.length) * 100;
                }
            }

            if (!Number.isFinite(progress)) {
                progress = 0;
            }
            progress = Math.max(0, Math.min(100, progress));

            document.getElementById('targetProgress').textContent = Math.round(progress) + '%';
            document.getElementById('progressFill').style.width = progress + '%';
            
            const fillEl = document.getElementById('progressFill');
            if (progress >= 80) {
                fillEl.style.backgroundColor = '#10b981';
            } else if (progress >= 60) {
                fillEl.style.backgroundColor = '#f59e0b';
            } else {
                fillEl.style.backgroundColor = '#ef4444';
            }
            
            const progressTextEl = document.getElementById('progressText');
            if (monthAvg !== null) {
                const displayMonthAvg = convertUnit(monthAvg).toFixed(1);
                const targetDisplay = convertUnit(parseFloat(glucoseRanges.targetAvg) || 0).toFixed(1);
                progressTextEl.textContent = '本月达标率: ' + Math.round(progress) + '% (月均 ' + displayMonthAvg + ' / 目标 ' + targetDisplay + ')';
            } else {
                progressTextEl.textContent = '本月达标率: ' + Math.round(progress) + '%';
            }
            
            const statusEl = document.getElementById('targetStatus');
            if (progress >= 80) {
                statusEl.textContent = '达标';
                statusEl.style.color = '#10b981';
                statusEl.style.fontWeight = 'bold';
            } else {
                statusEl.textContent = '进行中';
                statusEl.style.color = '#f59e0b';
                statusEl.style.fontWeight = 'normal';
            }
        }

        // 更新历史表格
        function updateHistoryTable() {
            const tableBody = document.getElementById('glucoseTableBody');
            const dateFromEl = document.getElementById('filterDateFrom');
            const dateToEl = document.getElementById('filterDateTo');
            const typeEl = document.getElementById('filterType');

            let filteredData = glucoseData.slice();

            if (dateFromEl && dateFromEl.value) {
                const from = dateFromEl.value;
                filteredData = filteredData.filter(item => item.date >= from);
            }

            if (dateToEl && dateToEl.value) {
                const to = dateToEl.value;
                filteredData = filteredData.filter(item => item.date <= to);
            }

            if (typeEl && typeEl.value) {
                const type = typeEl.value;
                filteredData = filteredData.filter(item => item.type === type);
            }
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr class="empty-state"><td colspan="7"><i class="fas fa-database"></i><p>暂无血糖记录</p></td></tr>';
                document.getElementById('recordCount').textContent = '共 0 条记录';
                return;
            }

            let html = '';
            filteredData.forEach(item => {
                const status = getGlucoseStatus(item.value, item.type);
                const statusClass = status === '正常' ? 'badge-normal' : status === '偏高' ? 'badge-high' : 'badge-low';
                
                html += `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.time}</td>
                    <td>${getTypeText(item.type)}</td>
                    <td>${convertUnit(item.value).toFixed(1)}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>${item.notes || '-'}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit-btn" data-id="${item.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            });

            tableBody.innerHTML = html;
            document.getElementById('recordCount').textContent = '共 ' + filteredData.length + ' 条记录';

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    const record = glucoseData.find(item => item.id === id);
                    if (!record) return;
                    editingRecordId = id;
                    document.querySelector('.nav-item[data-section="record"]').click();
                    const valueInput = document.getElementById('glucoseValue');
                    const dateInput = document.getElementById('measureDate');
                    const timeInput = document.getElementById('measureTime');
                    const typeSelect = document.getElementById('measureType');
                    const notesInput = document.getElementById('glucoseNotes');
                    if (valueInput) {
                        const displayValue = currentUnit === 'mg/dL' ? (record.value * 18).toFixed(1) : record.value.toFixed(1);
                        valueInput.value = displayValue;
                    }
                    if (dateInput) dateInput.value = record.date;
                    if (timeInput) timeInput.value = record.time;
                    if (typeSelect) typeSelect.value = record.type;
                    if (notesInput) notesInput.value = record.notes || '';
                    const submitBtn = document.querySelector('#glucoseForm button[type="submit"] span');
                    if (submitBtn) submitBtn.textContent = '保存修改';
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    glucoseData = glucoseData.filter(item => item.id !== id);
                    localStorage.setItem('glucoseData', JSON.stringify(glucoseData));
                    
                    if (cloudConnected) {
                        syncLocalToCloud().catch(err => {
                            console.warn('自动同步失败:', err);
                        });
                    }
                    
                    updateHistoryTable();
                    updateDashboardStats();
                    updateTrendStats();
                    initCharts();
                    showAlert('记录已删除', 'info');
                });
            });
        }

        // 更新趋势统计
        function updateTrendStats() {
            if (glucoseData.length === 0) {
                document.getElementById('weekMax').textContent = '--';
                document.getElementById('weekMin').textContent = '--';
                document.getElementById('weekAvg').textContent = '--';
                document.getElementById('weekAbnormal').textContent = '0';
                return;
            }

            // 本周数据
            const weekData = glucoseData.filter(item => {
                const recordDate = new Date(item.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return recordDate >= weekAgo;
            });

            if (weekData.length === 0) {
                document.getElementById('weekMax').textContent = '--';
                document.getElementById('weekMin').textContent = '--';
                document.getElementById('weekAvg').textContent = '--';
                document.getElementById('weekAbnormal').textContent = '0';
                return;
            }

            // 最大值
            const max = Math.max(...weekData.map(item => item.value));
            document.getElementById('weekMax').textContent = convertUnit(max).toFixed(1);

            // 最小值
            const min = Math.min(...weekData.map(item => item.value));
            document.getElementById('weekMin').textContent = convertUnit(min).toFixed(1);

            // 平均值
            const avg = weekData.reduce((sum, item) => sum + item.value, 0) / weekData.length;
            document.getElementById('weekAvg').textContent = convertUnit(avg).toFixed(1);

            // 异常次数
            const abnormal = weekData.filter(item => getGlucoseStatus(item.value, item.type) !== '正常').length;
            document.getElementById('weekAbnormal').textContent = abnormal;
        }

        // 更新同步统计
        function updateSyncStats(syncDate = null) {
            const cloudCount = cloudConnected ? cloudRecordCount : 0;
            document.getElementById('syncedRecords').textContent = cloudCount;
            document.getElementById('localRecords').textContent = glucoseData.length;
            document.getElementById('pendingSync').textContent = Math.max(glucoseData.length - cloudCount, 0);

            const lastSyncEl = document.getElementById('lastSyncTime');
            if (!lastSyncEl) return;

            if (syncDate) {
                lastSyncEl.textContent = '最后同步：' + new Date(syncDate).toLocaleString();
            } else if (cloudConnected) {
                lastSyncEl.textContent = '最后同步：' + new Date().toLocaleString();
            } else {
                lastSyncEl.textContent = '最后同步：未连接';
            }
        }

        // 添加同步日志
        function addSyncLog(message, type) {
            const logList = document.getElementById('syncLogList');
            
            // 移除空状态
            if (logList.querySelector('.sync-log-empty')) {
                logList.innerHTML = '';
            }

            // 创建日志项
            const logItem = document.createElement('div');
            logItem.className = 'sync-log-item ' + type;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            else if (type === 'error') icon = 'exclamation-circle';
            else if (type === 'warning') icon = 'exclamation-triangle';

            logItem.innerHTML = `
                <div class="log-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="log-content">
                    <div class="log-message">${message}</div>
                    <div class="log-time">${new Date().toLocaleString()}</div>
                </div>
            `;

            // 添加到日志列表
            logList.prepend(logItem);
        }

        // 单位转换
        function convertUnit(value) {
            if (currentUnit === 'mg/dL') {
                return value * 18;
            }
            return value;
        }

        // 获取血糖状态
        function getGlucoseStatus(value, type) {
            let min, max;
            
            if (type === 'fasting') {
                min = glucoseRanges.fasting.min;
                max = glucoseRanges.fasting.max;
            } else if (type === 'post-meal-1h' || type === 'post-meal-2h') {
                min = glucoseRanges.postMeal.min;
                max = glucoseRanges.postMeal.max;
            } else {
                min = glucoseRanges.random.min;
                max = glucoseRanges.random.max;
            }

            if (value < min) return '偏低';
            if (value > max) return '偏高';
            return '正常';
        }

        // 获取测量类型文本
        function getTypeText(type) {
            switch(type) {
                case 'fasting': return '空腹';
                case 'post-meal-1h': return '餐后1小时';
                case 'post-meal-2h': return '餐后2小时';
                case 'random': return '随机测量';
                case 'before-meal': return '餐前';
                default: return type;
            }
        }

        // 显示提示
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = 'alert ' + (type === 'success' ? 'alert-warning' : type === 'error' ? 'alert-danger' : 'alert-warning');
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            else if (type === 'error') icon = 'exclamation-circle';

            alert.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;

            alertContainer.appendChild(alert);
            
            // 3秒后移除
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }, 3000);
        }

        // 获取要导出的数据（根据筛选条件）
        function getExportData() {
            let data = [...glucoseData];
            
            // 根据日期范围筛选
            const dateFrom = document.getElementById('exportDateFrom')?.value;
            const dateTo = document.getElementById('exportDateTo')?.value;
            if (dateFrom) {
                data = data.filter(item => item.date >= dateFrom);
            }
            if (dateTo) {
                data = data.filter(item => item.date <= dateTo);
            }
            
            // 根据类型筛选
            const exportType = document.getElementById('exportType')?.value;
            if (exportType === 'fasting') {
                data = data.filter(item => item.type === 'fasting');
            } else if (exportType === 'post-meal') {
                data = data.filter(item => item.type === 'post-meal-1h' || item.type === 'post-meal-2h');
            }
            
            // 排序（按时间倒序）
            data.sort((a, b) => {
                const timeA = new Date(a.date + ' ' + a.time).getTime();
                const timeB = new Date(b.date + ' ' + b.time).getTime();
                return timeB - timeA;
            });
            
            return data;
        }

        // 导出为CSV
        function exportToCSV() {
            const data = getExportData();
            
            if (data.length === 0) {
                showAlert('没有可导出的数据', 'error');
                return;
            }
            
            // 检查是否使用mg/dL单位
            const useMgdl = document.getElementById('exportUnitMgdl')?.checked || false;
            
            // CSV表头
            const headers = ['日期', '时间', '测量类型', `血糖值(${useMgdl ? 'mg/dL' : 'mmol/L'})`, '状态', '备注'];
            const csvRows = [headers.join(',')];
            
            // 添加数据行
            data.forEach(item => {
                const status = getGlucoseStatus(item.value, item.type);
                const value = useMgdl ? convertUnit(item.value) : item.value;
                const row = [
                    item.date,
                    item.time,
                    getTypeText(item.type),
                    value.toFixed(1),
                    status,
                    (item.notes || '').replace(/,/g, '，') // 替换逗号避免CSV格式错误
                ];
                csvRows.push(row.join(','));
            });
            
            // 创建CSV内容
            const csvContent = csvRows.join('\n');
            
            // 添加BOM以支持Excel正确显示中文
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const link = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            link.href = URL.createObjectURL(blob);
            link.download = `血糖记录_${dateStr}.csv`;
            link.click();
            
            showAlert('CSV文件已导出', 'success');
        }

        // 导出为Excel
        function exportToExcel() {
            const data = getExportData();
            
            if (data.length === 0) {
                showAlert('没有可导出的数据', 'error');
                return;
            }
            
            // 检查是否使用mg/dL单位
            const useMgdl = document.getElementById('exportUnitMgdl')?.checked || false;
            
            // 准备Excel数据
            const excelData = [
                ['日期', '时间', '测量类型', `血糖值(${useMgdl ? 'mg/dL' : 'mmol/L'})`, '状态', '备注']
            ];
            
            data.forEach(item => {
                const status = getGlucoseStatus(item.value, item.type);
                const value = useMgdl ? convertUnit(item.value) : item.value;
                excelData.push([
                    item.date,
                    item.time,
                    getTypeText(item.type),
                    parseFloat(value.toFixed(1)),
                    status,
                    item.notes || ''
                ]);
            });
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // 设置列宽
            ws['!cols'] = [
                { wch: 12 }, // 日期
                { wch: 8 },  // 时间
                { wch: 12 }, // 测量类型
                { wch: 15 }, // 血糖值
                { wch: 8 },  // 状态
                { wch: 30 }  // 备注
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '血糖记录');
            
            // 导出文件
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `血糖记录_${dateStr}.xlsx`);
            
            showAlert('Excel文件已导出', 'success');
        }

        // 导出为PDF（使用html2canvas避免中文乱码）
        async function exportToPDF() {
            const data = getExportData();
            
            if (data.length === 0) {
                showAlert('没有可导出的数据', 'error');
                return;
            }
            
            // 检查选项
            const useMgdl = document.getElementById('exportUnitMgdl')?.checked || false;
            const withChart = document.getElementById('exportWithChart')?.checked || false;
            const withAnalysis = document.getElementById('exportWithAnalysis')?.checked || false;
            
            try {
                showLoading();
                
                // 创建临时导出容器
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '210mm'; // A4宽度
                exportContainer.style.padding = '20mm';
                exportContainer.style.backgroundColor = '#ffffff';
                exportContainer.style.fontFamily = 'Arial, "Microsoft YaHei", sans-serif';
                document.body.appendChild(exportContainer);
                
                // 构建PDF内容HTML
                let html = `
                    <div style="font-family: Arial, 'Microsoft YaHei', sans-serif; color: #000;">
                        <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px;">血糖记录报表</h1>
                        
                        <div style="margin-bottom: 20px; font-size: 14px;">
                            <p><strong>用户:</strong> ${userProfile.name}</p>
                            <p><strong>导出日期:</strong> ${new Date().toLocaleDateString('zh-CN')}</p>
                            <p><strong>记录数量:</strong> ${data.length} 条</p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f3f4f6;">
                                    <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">日期</th>
                                    <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">时间</th>
                                    <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">类型</th>
                                    <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">血糖值(${useMgdl ? 'mg/dL' : 'mmol/L'})</th>
                                    <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">状态</th>
                                    <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">备注</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(item => {
                    const status = getGlucoseStatus(item.value, item.type);
                    const value = useMgdl ? convertUnit(item.value) : item.value;
                    const statusColor = status === '正常' ? '#10b981' : status === '偏高' ? '#ef4444' : '#f59e0b';
                    
                    html += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.date}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.time}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${getTypeText(item.type)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${value.toFixed(1)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; color: ${statusColor}; font-weight: bold;">${status}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${(item.notes || '').replace(/\n/g, ' ')}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                `;

                // 添加图表部分
                if (withChart && data.length > 0) {
                    html += `
                        <div style="margin-top: 30px; margin-bottom: 30px; page-break-inside: avoid;">
                            <h2 style="font-size: 18px; margin-bottom: 15px;">血糖趋势图</h2>
                            <div style="width: 100%; height: 300px; position: relative;">
                                <canvas id="exportChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 添加分析部分
                if (withAnalysis && data.length > 0) {
                    const avg = data.reduce((sum, item) => sum + item.value, 0) / data.length;
                    const max = Math.max(...data.map(item => item.value));
                    const min = Math.min(...data.map(item => item.value));
                    const normalCount = data.filter(item => getGlucoseStatus(item.value, item.type) === '正常').length;
                    const abnormalCount = data.length - normalCount;
                    const normalRate = ((normalCount / data.length) * 100).toFixed(1);
                    
                    html += `
                        <div style="margin-top: 30px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">
                            <h2 style="font-size: 18px; margin-bottom: 15px;">数据分析</h2>
                            <div style="font-size: 14px; line-height: 2;">
                                <p><strong>平均血糖值:</strong> ${(useMgdl ? convertUnit(avg) : avg).toFixed(1)} ${useMgdl ? 'mg/dL' : 'mmol/L'}</p>
                                <p><strong>最高血糖值:</strong> ${(useMgdl ? convertUnit(max) : max).toFixed(1)} ${useMgdl ? 'mg/dL' : 'mmol/L'}</p>
                                <p><strong>最低血糖值:</strong> ${(useMgdl ? convertUnit(min) : min).toFixed(1)} ${useMgdl ? 'mg/dL' : 'mmol/L'}</p>
                                <p><strong>正常记录数:</strong> ${normalCount} / ${data.length} (${normalRate}%)</p>
                                <p><strong>异常记录数:</strong> ${abnormalCount} / ${data.length}</p>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                exportContainer.innerHTML = html;

                // 渲染图表
                if (withChart && data.length > 0) {
                    // 按时间正序排列数据
                    const chartData = [...data].sort((a, b) => {
                        return new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time);
                    });

                    const ctx = exportContainer.querySelector('#exportChart').getContext('2d');
                    
                    // 创建图表
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartData.map(item => {
                                const d = new Date(item.date);
                                return `${d.getMonth() + 1}/${d.getDate()} ${item.time}`;
                            }),
                            datasets: [{
                                label: `血糖值 (${useMgdl ? 'mg/dL' : 'mmol/L'})`,
                                data: chartData.map(item => useMgdl ? convertUnit(item.value) : item.value),
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true,
                                pointRadius: 3,
                                pointBackgroundColor: '#ffffff',
                                pointBorderColor: '#4f46e5'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: useMgdl ? 'mg/dL' : 'mmol/L'
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxTicksLimit: 20
                                    }
                                }
                            }
                        }
                    });
                    
                    // 等待图表渲染完成
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // 使用html2canvas转换为图片
                const canvas = await html2canvas(exportContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                
                // 移除临时容器
                document.body.removeChild(exportContainer);
                
                // 计算PDF尺寸
                const imgWidth = 210; // A4宽度 (mm)
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pdfHeight = 297; // A4高度 (mm)
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // 如果内容超过一页，需要分页
                let heightLeft = imgHeight;
                let position = 0;
                
                // 添加第一页
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
                
                // 添加后续页面
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                
                // 保存文件
                const dateStr = new Date().toISOString().split('T')[0];
                pdf.save(`血糖记录_${dateStr}.pdf`);
                
                hideLoading();
                showAlert('PDF文件已导出', 'success');
            } catch (error) {
                console.error('PDF导出错误:', error);
                hideLoading();
                showAlert('PDF导出失败: ' + error.message, 'error');
            }
        }

        // 显示加载动画
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // 隐藏加载动画
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
